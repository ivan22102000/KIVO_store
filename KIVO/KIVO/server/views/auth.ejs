<% 
// Set page context for navigation
let page = 'auth';
let description = 'Iniciar sesión o crear cuenta en Kivo Store con autenticación segura de Supabase';
%>

<!-- Authentication Section -->
<section class="auth-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="auth-card" data-testid="card-auth">
                    <div class="text-center mb-4">
                        <h1 class="auth-title" data-testid="text-auth-title">Bienvenido a Kivo Store</h1>
                        <p class="text-muted" data-testid="text-auth-subtitle">
                            Inicia sesión para acceder a tu cuenta
                        </p>
                    </div>

                    <!-- Login Form -->
                    <div id="loginSection" data-testid="section-login">
                        <form id="loginForm" data-testid="form-login">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="loginEmail" name="email" placeholder="name@example.com" required data-testid="input-login-email">
                                <label for="loginEmail">Correo Electrónico</label>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Password" required data-testid="input-login-password">
                                <label for="loginPassword">Contraseña</label>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="rememberMe" data-testid="checkbox-remember">
                                    <label class="form-check-label" for="rememberMe">
                                        Recordarme
                                    </label>
                                </div>
                                <a href="#" class="text-decoration-none" style="color: var(--primary-color);" onclick="showNotification('Funcionalidad próximamente disponible')" data-testid="link-forgot-password">
                                    ¿Olvidaste tu contraseña?
                                </a>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3" data-testid="button-login">
                                <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                            </button>

                            <div class="text-center">
                                <span class="loading-spinner d-none" id="loginSpinner" data-testid="spinner-login"></span>
                            </div>
                        </form>
                        
                        <hr>
                        
                        <p class="text-center text-muted">
                            ¿No tienes cuenta? 
                            <a href="#" class="text-decoration-none" style="color: var(--primary-color);" onclick="showRegisterForm()" data-testid="link-show-register">
                                Regístrate aquí
                            </a>
                        </p>
                    </div>

                    <!-- Register Form -->
                    <div id="registerSection" class="d-none" data-testid="section-register">
                        <form id="registerForm" data-testid="form-register">
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="registerEmail" name="email" placeholder="name@example.com" required data-testid="input-register-email">
                                <label for="registerEmail">Correo Electrónico</label>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="registerPassword" name="password" placeholder="Password" required minlength="6" data-testid="input-register-password">
                                <label for="registerPassword">Contraseña (mínimo 6 caracteres)</label>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm Password" required data-testid="input-confirm-password">
                                <label for="confirmPassword">Confirmar Contraseña</label>
                            </div>

                            <div class="form-floating mb-3">
                                <input type="tel" class="form-control" id="registerPhone" name="phone" placeholder="Teléfono (opcional)" data-testid="input-register-phone">
                                <label for="registerPhone">Teléfono (opcional)</label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="acceptTerms" required data-testid="checkbox-terms">
                                <label class="form-check-label" for="acceptTerms">
                                    Acepto los <a href="#" style="color: var(--primary-color);">términos y condiciones</a>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3" data-testid="button-register">
                                <i class="fas fa-user-plus me-2"></i>Crear Cuenta
                            </button>

                            <div class="text-center">
                                <span class="loading-spinner d-none" id="registerSpinner" data-testid="spinner-register"></span>
                            </div>
                        </form>
                        
                        <hr>
                        
                        <p class="text-center text-muted">
                            ¿Ya tienes cuenta? 
                            <a href="#" class="text-decoration-none" style="color: var(--primary-color);" onclick="showLoginForm()" data-testid="link-show-login">
                                Inicia sesión aquí
                            </a>
                        </p>
                    </div>

                    <!-- Demo Credentials -->
                    <div class="mt-4 p-3 bg-light rounded" data-testid="div-demo-credentials">
                        <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Credenciales de Demostración</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Usuario Admin:</strong><br>
                                    admin@kivo.com<br>
                                    password123
                                </small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Usuario Normal:</strong><br>
                                    user@kivo.com<br>
                                    password123
                                </small>
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm mt-2 w-100" onclick="fillDemoCredentials('admin')" data-testid="button-demo-admin">
                            Usar Credenciales de Admin
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Authentication JavaScript
document.addEventListener('DOMContentLoaded', function() {
    setupAuthForms();
});

function setupAuthForms() {
    // Login form handler
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }

    // Register form handler
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
    }

    // Password confirmation validation
    const confirmPassword = document.getElementById('confirmPassword');
    if (confirmPassword) {
        confirmPassword.addEventListener('input', validatePasswordMatch);
    }
}

async function handleLogin(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const password = formData.get('password');
    
    const spinner = document.getElementById('loginSpinner');
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    try {
        // Show loading state
        spinner.classList.remove('d-none');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando sesión...';
        
        // Use Supabase client for authentication
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) {
            throw error;
        }
        
        if (data.user && data.session) {
            // Store token for API requests
            localStorage.setItem('supabase_token', data.session.access_token);
            
            showNotification('¡Sesión iniciada exitosamente!', 'success');
            
            // Redirect after successful login
            setTimeout(() => {
                // Check if user is admin and redirect accordingly
                if (data.user.user_metadata?.is_admin) {
                    window.location.href = '/admin';
                } else {
                    window.location.href = '/';
                }
            }, 1000);
        }
    } catch (error) {
        console.error('Error during login:', error);
        
        let message = 'Error al iniciar sesión';
        if (error.message?.includes('Invalid login credentials')) {
            message = 'Credenciales inválidas. Verifica tu email y contraseña.';
        } else if (error.message?.includes('Email not confirmed')) {
            message = 'Confirma tu email antes de iniciar sesión.';
        }
        
        showNotification(message, 'error');
    } finally {
        // Reset loading state
        spinner.classList.add('d-none');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión';
    }
}

async function handleRegister(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');
    const phone = formData.get('phone');
    
    // Validate password match
    if (password !== confirmPassword) {
        showNotification('Las contraseñas no coinciden', 'error');
        return;
    }
    
    const spinner = document.getElementById('registerSpinner');
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    try {
        // Show loading state
        spinner.classList.remove('d-none');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando cuenta...';
        
        // Use Supabase client for registration
        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    phone: phone || null
                }
            }
        });
        
        if (error) {
            throw error;
        }
        
        if (data.user) {
            showNotification('¡Cuenta creada exitosamente! Revisa tu email para confirmar tu cuenta.', 'success');
            
            // Switch to login form
            setTimeout(() => {
                showLoginForm();
                document.getElementById('loginEmail').value = email;
            }, 2000);
        }
    } catch (error) {
        console.error('Error during registration:', error);
        
        let message = 'Error al crear la cuenta';
        if (error.message?.includes('User already registered')) {
            message = 'Este email ya está registrado. Intenta iniciar sesión.';
        } else if (error.message?.includes('Password should be at least')) {
            message = 'La contraseña debe tener al menos 6 caracteres.';
        }
        
        showNotification(message, 'error');
    } finally {
        // Reset loading state
        spinner.classList.add('d-none');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-user-plus me-2"></i>Crear Cuenta';
    }
}

function validatePasswordMatch() {
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const confirmInput = document.getElementById('confirmPassword');
    
    if (confirmPassword && password !== confirmPassword) {
        confirmInput.setCustomValidity('Las contraseñas no coinciden');
        confirmInput.classList.add('is-invalid');
    } else {
        confirmInput.setCustomValidity('');
        confirmInput.classList.remove('is-invalid');
    }
}

function showLoginForm() {
    document.getElementById('loginSection').classList.remove('d-none');
    document.getElementById('registerSection').classList.add('d-none');
    document.querySelector('[data-testid="text-auth-title"]').textContent = 'Bienvenido de Vuelta';
    document.querySelector('[data-testid="text-auth-subtitle"]').textContent = 'Inicia sesión para acceder a tu cuenta';
}

function showRegisterForm() {
    document.getElementById('loginSection').classList.add('d-none');
    document.getElementById('registerSection').classList.remove('d-none');
    document.querySelector('[data-testid="text-auth-title"]').textContent = 'Crear Cuenta Nueva';
    document.querySelector('[data-testid="text-auth-subtitle"]').textContent = 'Únete a nuestra comunidad hoy';
}

function fillDemoCredentials(type) {
    if (type === 'admin') {
        document.getElementById('loginEmail').value = 'admin@kivo.com';
        document.getElementById('loginPassword').value = 'password123';
    } else {
        document.getElementById('loginEmail').value = 'user@kivo.com';
        document.getElementById('loginPassword').value = 'password123';
    }
    
    showLoginForm();
    showNotification('Credenciales de demostración cargadas', 'info');
}
</script>
